{"version":3,"sources":["../../../src/controllers/middlewares/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import cors from 'cors';\nimport errors from '../../utils/error';\nimport conf from '../../conf';\nimport jwt from 'jsonwebtoken';\n\n/**\n * JSON Formatter\n * @param req\n * @param res\n * @param next\n */\nexport function rest(req, res, next) {\n\tres.shoot = function(dataOrPromise, serialize) {\n\t\t(Promise.isPromise(dataOrPromise) ? dataOrPromise : Promise.resolve(dataOrPromise))\n\t\t\t.then((data) => {\n\t\t\t\tvar serialized = data;\n\t\t\t\tif (serialize) {\n\t\t\t\t\tserialized = _.pick(data, serialize);\n\t\t\t\t}\n\n\t\t\t\tres.json(serialized);\n\t\t\t})\n\t\t\t.catch((err) => {\n\t\t\t\tsendError(req, res, err);\n\t\t\t});\n\t};\n\n\tnext();\n}\n\n/**\n * Sends error correctly from API\n * @param req\n * @param res\n * @param err\n */\nexport function sendError(req, res, err) {\n\terr.status = err.status || 500;\n\tlet data = {\n\t\tmessage: err.message,\n\t\ttype: (err.status < 500 && err.type) ? err.type : 'ServerError',\n\t\terrors: err.errors ? err.errors : undefined\n\t};\n\n\tres.status(err.status);\n\tres.json(data);\n}\n\nexport function error(err, req, res, next) {\n\t//console.log(err.stack);\n\tsendError(req, res, err);\n}\n\n/**\n * Security headers checker/little hack for security\n * @param req\n * @param res\n * @param next\n */\nexport function securityHeaders(req, res, next) {\n\t//remove default nginx and express headers\n\tres.removeHeader('X-Powered-By');\n\tres.removeHeader('Server');\n\n\t//keeps MIME type sniffing away\n\tres.header('X-Content-Type-Options', 'nosniff');\n\n\t//keeps iframe hijacking away\n\tres.header('X-Frame-Options', 'DENY');\n\n\t//prevents execution of downloads in our context, small IE bug, better safe than sorry\n\tres.setHeader('X-Download-Options', 'noopen');\n\n\t//forces HTTPS use\n\tif (process.env.NODE_ENV === 'prod')\n\t\tres.setHeader('Strict-Transport-Security', 'max-age=7776000000');\n\n\t//keeps xss attacks away\n\tvar matches = /msie\\s*(\\d+)/i.exec(req.headers['user-agent']),\n\t\tvalue;\n\n\tif (!matches || (parseFloat(matches[1]) >= 9)) {\n\t\tvalue = '1; mode=block';\n\t} else {\n\t\tvalue = '0';\n\t}\n\n\tres.setHeader('X-XSS-Protection', value);\n\n\tnext();\n}\n\n/**\n * adds cors wildcard to router\n * @param router\n */\nexport function useCors(router) {\n\trouter.use(cors());\n\trouter.options('*', cors());\n}\n\n/**\n * checks for token validity\n * @param req\n * @param res\n * @param next\n */\nexport function checkToken(req, res, next) {\n    console.log(\"passsssss\");\n\tvar token = req.body.token || req.query.token || req.headers['X-Auth-Token'];\n\n\t// decode token\n\tif (token) {\n\t\t// verifies secret and checks exp\n\t\tjwt.verify(token, conf[process.env.NODE_ENV].secretJWT, function(err, decoded) {\n\t\t\tif (err) {\n\t\t\t\treturn res.json({success: false, message: 'Failed to authenticate token.'});\n\t\t\t} else {\n\t\t\t\t// if everything is good, save to request for use in other routes\n\t\t\t\treq.decodedToken = decoded;\n\t\t\t\tnext();\n\t\t\t}\n\t\t});\n\n\t} else {\n\t\t// if there is no token\n\t\t// return an error\n\t\tthrow new errors.ForbiddenError('Missing auth token');\n\n\t}\n\n\tnext();\n}\n"]}