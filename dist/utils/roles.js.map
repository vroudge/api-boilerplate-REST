{"version":3,"sources":["../../src/utils/roles.js"],"names":[],"mappings":"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","file":"roles.js","sourcesContent":["import errors from './error';\nvar debug = require('debug')('amber');\n\nexport class Roles {\n\n\tconstructor() {\n\t\tthis.handlers = [];\n\t}\n\n\tregisterHandler(fn) {\n\t\tthis.handlers.push(fn);\n\t}\n\n\tuse() {\n\t\tif (arguments.length === 1) {\n\t\t\tdebug(`register wildcard handler (${ this.handlers.length })`);\n\t\t\tthis.registerHandler(arguments[0]);\n\t\t} else if (arguments.length === 2) {\n\t\t\tvar perm = arguments[0];\n\t\t\tvar fn = arguments[1];\n\t\t\tdebug(`register handler '${perm}' (${ this.handlers.length })`);\n\t\t\tthis.registerHandler(function(permission, ...args) {\n\t\t\t\tif (permission === perm) {\n\t\t\t\t\treturn fn.apply(this, args);\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t});\n\t\t} else {\n\t\t\tthrow new TypeError('use() expects one or two arguments');\n\t\t}\n\t}\n\n\tcan(context, permission, args) {\n\t\treturn this._testNextHandler(0, context, permission, args)\n\t\t\t.then((result) => {\n\t\t\t\tif (result === true) {\n\t\t\t\t\tdebug(`${permission} granted`);\n\t\t\t\t\treturn true;\n\t\t\t\t} else if (result === false) {\n\t\t\t\t\tdebug(`${permission} denied: no reason`);\n\t\t\t\t\treturn false;\n\t\t\t\t} else if (typeof result === 'string') {\n\t\t\t\t\tdebug(`${permission} denied: ${result}`);\n\t\t\t\t\treturn result;\n\t\t\t\t} else {\n\t\t\t\t\tdebug(`${permission} did not match any rule`);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t}, (error) => {\n\t\t\t\tif (error instanceof errors.ApiError) {\n\t\t\t\t\tdebug(`${permission} denieed: ${error.message} ${error.status}`);\n\t\t\t\t} else {\n\t\t\t\t\tdebug(`${permission} handler err'ed: ${error.message}`);\n\t\t\t\t}\n\t\t\t\tthrow error;\n\t\t\t});\n\t}\n\n\t_testNextHandler(handlerIndex, context, permission, args) {\n\t\tvar handler = this.handlers[handlerIndex];\n\t\tif (!handler) {\n\t\t\treturn Promise.resolve(null)\n\t\t};\n\t\tvar result = handler.apply(context, [ permission ].concat(args));\n\t\tif (!Promise.isPromise(result)) {\n\t\t\tresult = Promise.resolve(result);\n\t\t}\n\t\treturn result\n\t\t\t.then((r) => {\n\t\t\t\t// pass on to next\n\t\t\t\tif (r === null || r === undefined) {\n\t\t\t\t\tlet length = this.handlers.length;\n\t\t\t\t\tif (handlerIndex < length - 1) {\n\t\t\t\t\t\treturn this._testNextHandler(handlerIndex + 1, context, permission, args);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// if boolean or string skip remaining handlers\n\t\t\t\treturn r;\n\t\t\t});\n\t}\n}\n\nexport { Roles as SecurityRoles };\nexport default new Roles();\n"]}